{/*
  API Documentation | API æ–‡æ¡£
  
  RESTful API å®Œæ•´å‚è€ƒ / Complete RESTful API Reference
  ä¸­æ–‡åœ¨å‰ï¼Œè‹±æ–‡åœ¨å | Chinese first, English second
*/}

# API æ–‡æ¡£ | API Documentation

> **MediCare_AI** RESTful API å®Œæ•´å‚è€ƒ / Complete RESTful API Reference  
> **ç‰ˆæœ¬ / Version:** 2.0.0 | **Base URL:** `http://localhost:8000/api/v1`

---

## ğŸ“‹ ç›®å½• | Table of Contents

1. [æ¦‚è¿° | Overview](#overview)
2. [è®¤è¯ | Authentication](#authentication)
3. [é”™è¯¯å¤„ç† | Error Handling](#error-handling)
4. [API ç«¯ç‚¹ | API Endpoints](#endpoints)
5. [æ•°æ®æ¨¡å‹ | Data Models](#data-models)
6. [ä»£ç ç¤ºä¾‹ | Code Examples](#examples)

---

<a name="overview"></a>
## 1. æ¦‚è¿° | Overview

### 1.1 API è®¾è®¡åŸåˆ™ | API Design Principles

- **RESTful**: åŸºäºèµ„æºçš„ URL å’Œ HTTP åŠ¨è¯ / Resource-based URLs with HTTP verbs
- **JSON**: æ‰€æœ‰è¯·æ±‚å’Œå“åº”ä½¿ç”¨ JSON / All requests and responses use JSON
- **ç‰ˆæœ¬æ§åˆ¶**: API ç‰ˆæœ¬åœ¨ URL è·¯å¾„ä¸­ / API version in URL path (`/api/v1/`)
- **ä¸€è‡´æ€§**: æ ‡å‡†åŒ–çš„å“åº”æ ¼å¼ / Standardized response format
- **æ–‡æ¡£åŒ–**: è‡ªåŠ¨ç”Ÿæˆ Swagger/OpenAPI æ–‡æ¡£ / Auto-generated Swagger/OpenAPI docs

### 1.2 åŸºç¡€ URL | Base URL

```
å¼€å‘ç¯å¢ƒ / Development: http://localhost:8000/api/v1
ç”Ÿäº§ç¯å¢ƒ / Production:   https://your-domain.com/api/v1
```

### 1.3 è¯·æ±‚/å“åº”æ ¼å¼ | Request/Response Format

**æ ‡å‡†å“åº”ç»“æ„ / Standard Response Structure:**
```json
{
  "success": true,
  "data": { },
  "message": "æ“ä½œæˆåŠŸå®Œæˆ | Operation completed successfully",
  "timestamp": "2025-02-01T10:00:00Z"
}
```

**é”™è¯¯å“åº”ç»“æ„ / Error Response Structure:**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "è¯·æ±‚éªŒè¯å¤±è´¥ | Request validation failed",
    "details": [ ]
  },
  "timestamp": "2025-02-01T10:00:00Z"
}
```

---

<a name="authentication"></a>
## 2. è®¤è¯ | Authentication

### 2.1 JWT è®¤è¯ | JWT Authentication

MediCare_AI ä½¿ç”¨ JWT (JSON Web Token) è¿›è¡Œè®¤è¯ã€‚  
MediCare_AI uses JWT (JSON Web Token) for authentication.

**è®¤è¯æµç¨‹ / Authentication Flow:**
1. ç”¨æˆ·ç™»å½•è·å–è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œ / User logs in to get access and refresh tokens
2. åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«è®¿é—®ä»¤ç‰Œ / Include access token in request header
3. ä»¤ç‰Œè¿‡æœŸåä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°ä»¤ç‰Œ / Use refresh token to get new tokens after expiration

### 2.2 è®¤è¯å¤´ | Authentication Header

```http
Authorization: Bearer <access_token>
```

### 2.3 è®¤è¯ç«¯ç‚¹ | Authentication Endpoints

#### ç”¨æˆ·æ³¨å†Œ | User Registration
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securepassword123",
  "full_name": "å¼ ä¸‰ | Zhang San",
  "role": "patient"
}
```

**å“åº” / Response:**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "email": "user@example.com",
      "full_name": "å¼ ä¸‰ | Zhang San",
      "role": "patient"
    },
    "tokens": {
      "access_token": "eyJhbGciOiJIUzI1NiIs...",
      "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
      "token_type": "bearer",
      "expires_in": 1800
    }
  },
  "message": "æ³¨å†ŒæˆåŠŸ | Registration successful"
}
```

#### ç”¨æˆ·ç™»å½• | User Login
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securepassword123",
  "platform": "patient"  // patient, doctor, admin
}
```

#### åˆ·æ–°ä»¤ç‰Œ | Refresh Token
```http
POST /api/v1/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

---

<a name="error-handling"></a>
## 3. é”™è¯¯å¤„ç† | Error Handling

### 3.1 HTTP çŠ¶æ€ç  | HTTP Status Codes

| çŠ¶æ€ç  / Code | å«ä¹‰ / Meaning | è¯´æ˜ / Description |
|--------------|---------------|-------------------|
| 200 | OK | è¯·æ±‚æˆåŠŸ / Request successful |
| 201 | Created | èµ„æºåˆ›å»ºæˆåŠŸ / Resource created |
| 400 | Bad Request | è¯·æ±‚å‚æ•°é”™è¯¯ / Invalid request parameters |
| 401 | Unauthorized | æœªè®¤è¯ / Not authenticated |
| 403 | Forbidden | æ— æƒé™ / No permission |
| 404 | Not Found | èµ„æºä¸å­˜åœ¨ / Resource not found |
| 422 | Validation Error | æ•°æ®éªŒè¯å¤±è´¥ / Data validation failed |
| 500 | Internal Server Error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ / Internal server error |

### 3.2 é”™è¯¯ä»£ç  | Error Codes

| é”™è¯¯ä»£ç  / Code | è¯´æ˜ / Description |
|----------------|-------------------|
| `AUTHENTICATION_ERROR` | è®¤è¯å¤±è´¥ / Authentication failed |
| `AUTHORIZATION_ERROR` | æˆæƒå¤±è´¥ / Authorization failed |
| `VALIDATION_ERROR` | æ•°æ®éªŒè¯é”™è¯¯ / Validation error |
| `RESOURCE_NOT_FOUND` | èµ„æºä¸å­˜åœ¨ / Resource not found |
| `RESOURCE_CONFLICT` | èµ„æºå†²çª / Resource conflict |
| `INTERNAL_ERROR` | å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ / Internal server error |

---

<a name="endpoints"></a>
## 4. API ç«¯ç‚¹ | API Endpoints

### 4.1 è®¤è¯æ¨¡å— | Authentication Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| POST | `/auth/register` | ç”¨æˆ·æ³¨å†Œ / User registration |
| POST | `/auth/login` | ç”¨æˆ·ç™»å½• / User login |
| POST | `/auth/logout` | ç”¨æˆ·ç™»å‡º / User logout |
| POST | `/auth/refresh` | åˆ·æ–°ä»¤ç‰Œ / Refresh token |
| GET | `/auth/me` | è·å–å½“å‰ç”¨æˆ· / Get current user |

### 4.2 æ‚£è€…æ¨¡å— | Patient Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| GET | `/patients` | æ‚£è€…åˆ—è¡¨ / Patient list |
| POST | `/patients` | åˆ›å»ºæ‚£è€… / Create patient |
| GET | `/patients/me` | è·å–æˆ‘çš„æ‚£è€…æ¡£æ¡ˆ / Get my patient profile |
| PUT | `/patients/me` | æ›´æ–°æˆ‘çš„æ¡£æ¡ˆ / Update my profile |
| GET | `/patients/{id}` | è·å–æ‚£è€…è¯¦æƒ… / Get patient details |

### 4.3 AI è¯Šæ–­æ¨¡å— | AI Diagnosis Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| POST | `/ai/comprehensive-diagnosis` | å®Œæ•´è¯Šæ–­ / Comprehensive diagnosis |
| POST | `/ai/comprehensive-diagnosis-stream` | æµå¼å®Œæ•´è¯Šæ–­ / Streaming comprehensive diagnosis |
| POST | `/ai/diagnose` | ç®€å•è¯Šæ–­ / Simple diagnosis |
| POST | `/ai/analyze` | ç—‡çŠ¶åˆ†æ / Symptom analysis |

### 4.4 åŒ»ç–—è®°å½•æ¨¡å— | Medical Records Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| GET | `/medical-cases` | ç—…ä¾‹åˆ—è¡¨ / Case list |
| POST | `/medical-cases` | åˆ›å»ºç—…ä¾‹ / Create case |
| GET | `/medical-cases/{id}` | è·å–ç—…ä¾‹ / Get case |
| PUT | `/medical-cases/{id}` | æ›´æ–°ç—…ä¾‹ / Update case |
| DELETE | `/medical-cases/{id}` | åˆ é™¤ç—…ä¾‹ / Delete case |

### 4.5 æ–‡æ¡£æ¨¡å— | Document Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| POST | `/documents/upload` | ä¸Šä¼ æ–‡ä»¶ / Upload file |
| GET | `/documents/{id}` | è·å–æ–‡æ¡£ / Get document |
| POST | `/documents/{id}/extract` | æå–æ–‡æœ¬ / Extract text |
| GET | `/documents/{id}/content` | è·å–æ–‡æ¡£å†…å®¹ / Get document content |
| GET | `/documents/{id}/pii-status` | è·å– PII æ¸…æ´—çŠ¶æ€ / Get PII cleaning status |

### 4.6 åŒ»ç”Ÿæ¨¡å— | Doctor Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| GET | `/doctor/cases` | è·å–åŒ»ç”Ÿçš„ç—…ä¾‹ / Get doctor's cases |
| GET | `/doctor/cases/{id}` | è·å–ç—…ä¾‹è¯¦æƒ… / Get case details |
| POST | `/doctor/cases/{id}/comments` | æ·»åŠ è¯„è®º / Add comment |
| GET | `/doctor/mentions` | è·å– @æˆ‘çš„ç—…ä¾‹ / Get @my cases |

### 4.7 åˆ†äº«æ¨¡å— | Sharing Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| GET | `/sharing/doctors` | æœç´¢åŒ»ç”Ÿ / Search doctors |
| POST | `/sharing/cases` | åˆ†äº«ç—…ä¾‹ / Share case |
| GET | `/sharing/cases/{id}` | è·å–åˆ†äº«ç—…ä¾‹ / Get shared case |
| POST | `/sharing/cases/{id}/comments` | æ·»åŠ è¯„è®º / Add comment |
| POST | `/sharing/cases/{id}/comments/{cid}/reply` | å›å¤è¯„è®º / Reply to comment |

### 4.8 ç®¡ç†å‘˜æ¨¡å— | Admin Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| GET | `/admin/dashboard/summary` | ä»ªè¡¨æ¿æ‘˜è¦ / Dashboard summary |
| GET | `/admin/doctors` | åŒ»ç”Ÿåˆ—è¡¨ / Doctor list |
| POST | `/admin/doctors/{id}/verify` | å®¡æ ¸åŒ»ç”Ÿ / Verify doctor |
| GET | `/admin/operation-logs` | æ“ä½œæ—¥å¿— / Operation logs |
| GET | `/admin/ai-diagnosis-logs` | AI è¯Šæ–­æ—¥å¿— / AI diagnosis logs |
| POST | `/admin/doctors/sync-verification` | åŒæ­¥åŒ»ç”Ÿè®¤è¯çŠ¶æ€ / Sync doctor verification |

### 4.9 å‘é‡åµŒå…¥æ¨¡å— | Vector Embedding Module

| æ–¹æ³• / Method | ç«¯ç‚¹ / Endpoint | æè¿° / Description |
|--------------|----------------|-------------------|
| POST | `/vector-embedding/documents` | å‘é‡åŒ–æ–‡æ¡£ / Vectorize document |
| GET | `/vector-embedding/documents/{id}/status` | è·å–å‘é‡åŒ–çŠ¶æ€ / Get vectorization status |
| POST | `/vector-embedding/knowledge-base` | å‘é‡åŒ–çŸ¥è¯†åº“ / Vectorize knowledge base |
| POST | `/vector-embedding/smart-rag` | æ™ºèƒ½ RAG æ£€ç´¢ / Smart RAG retrieval |

---

<a name="data-models"></a>
## 5. æ•°æ®æ¨¡å‹ | Data Models

### 5.1 ç”¨æˆ·æ¨¡å‹ | User Model

```json
{
  "id": "uuid",
  "email": "user@example.com",
  "full_name": "å¼ ä¸‰ | Zhang San",
  "role": "patient",  // patient, doctor, admin
  "is_active": true,
  "is_verified": true,
  "phone": "13800138000",
  "created_at": "2025-02-01T10:00:00Z",
  "updated_at": "2025-02-01T10:00:00Z"
}
```

### 5.2 æ‚£è€…æ¨¡å‹ | Patient Model

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "date_of_birth": "1990-01-01",
  "gender": "male",  // male, female, other
  "phone": "13800138000",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº",
  "emergency_contact_name": "æå››",
  "emergency_contact_phone": "13900139000",
  "medical_record_number": "MR2024001",
  "created_at": "2025-02-01T10:00:00Z"
}
```

### 5.3 ç—…ä¾‹æ¨¡å‹ | Medical Case Model

```json
{
  "id": "uuid",
  "patient_id": "uuid",
  "disease_id": "uuid",
  "title": "åå¤å’³å—½ã€å–˜æ¯",
  "symptoms": "æ‚£è€…è¿‘ä¸€å‘¨åå¤å’³å—½...",
  "diagnosis": "æ”¯æ°”ç®¡å“®å–˜",
  "severity": "moderate",  // mild, moderate, severe
  "status": "active",
  "created_at": "2025-02-01T10:00:00Z",
  "updated_at": "2025-02-01T10:00:00Z"
}
```

### 5.4 æ–‡æ¡£æ¨¡å‹ | Document Model

```json
{
  "id": "uuid",
  "medical_case_id": "uuid",
  "filename": "è¡€å¸¸è§„æŠ¥å‘Š.pdf",
  "file_type": "pdf",
  "file_size": 1024567,
  "storage_type": "oss",  // local, oss
  "storage_path": "documents/xxxx.pdf",
  "extracted_content": "ç™½ç»†èƒè®¡æ•°: 7.5...",
  "pii_cleaned_content": "ç™½ç»†èƒè®¡æ•°: 7.5...",
  "pii_cleaning_status": "completed",  // pending, processing, completed, failed
  "upload_status": "processed",  // pending, uploaded, processing, processed, failed
  "created_at": "2025-02-01T10:00:00Z"
}
```

### 5.5 AI åé¦ˆæ¨¡å‹ | AI Feedback Model

```json
{
  "id": "uuid",
  "medical_case_id": "uuid",
  "diagnosis_result": "åˆæ­¥è¯Šæ–­ï¼šæ”¯æ°”ç®¡å“®å–˜æ€¥æ€§å‘ä½œæœŸ",
  "confidence": 0.92,
  "reasoning": "æ ¹æ®æ‚£è€…ç—‡çŠ¶å’Œæ£€æŸ¥ç»“æœ...",
  "suggestions": ["å»ºè®®ç»§ç»­å¸å…¥æ¿€ç´ æ²»ç–—", "å®šæœŸå¤æŸ¥è‚ºåŠŸèƒ½"],
  "warnings": ["æ³¨æ„è¯ç‰©å‰¯ä½œç”¨"],
  "follow_up_plan": "1å‘¨åå¤è¯Š",
  "model_used": "GLM-4.7-Flash",
  "created_at": "2025-02-01T10:00:00Z"
}
```

---

<a name="examples"></a>
## 6. ä»£ç ç¤ºä¾‹ | Code Examples

### 6.1 å®Œæ•´å·¥ä½œæµç¤ºä¾‹ | Complete Workflow Example

```bash
#!/bin/bash
# å®Œæ•´ API è°ƒç”¨ç¤ºä¾‹ / Complete API call example

BASE_URL="http://localhost:8000/api/v1"

# 1. ç”¨æˆ·æ³¨å†Œ / User registration
REGISTER_RESPONSE=$(curl -s -X POST "${BASE_URL}/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@medicare.ai",
    "password": "Test123456!",
    "full_name": "æµ‹è¯•ç”¨æˆ· | Test User",
    "role": "patient"
  }')

# 2. ç”¨æˆ·ç™»å½• / User login
LOGIN_RESPONSE=$(curl -s -X POST "${BASE_URL}/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@medicare.ai",
    "password": "Test123456!",
    "platform": "patient"
  }')

ACCESS_TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.data.tokens.access_token')

# 3. è·å–å½“å‰ç”¨æˆ· / Get current user
curl -s "${BASE_URL}/auth/me" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}"

# 4. åˆ›å»ºç—…ä¾‹ / Create case
curl -s -X POST "${BASE_URL}/medical-cases" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "å’³å—½ç—‡çŠ¶",
    "symptoms": "åå¤å’³å—½ä¸€å‘¨...",
    "severity": "moderate"
  }'

# 5. AI è¯Šæ–­ / AI diagnosis
curl -s -X POST "${BASE_URL}/ai/comprehensive-diagnosis" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "symptoms": "åå¤å’³å—½ã€å–˜æ¯",
    "severity": "moderate",
    "language": "zh"
  }'
```

### 6.2 Python ç¤ºä¾‹ | Python Example

```python
import requests

BASE_URL = "http://localhost:8000/api/v1"

# ç™»å½• / Login
login_response = requests.post(f"{BASE_URL}/auth/login", json={
    "email": "test@medicare.ai",
    "password": "Test123456!",
    "platform": "patient"
})
tokens = login_response.json()["data"]["tokens"]
access_token = tokens["access_token"]

headers = {
    "Authorization": f"Bearer {access_token}",
    "Content-Type": "application/json"
}

# è·å–æ‚£è€…åˆ—è¡¨ / Get patient list
response = requests.get(f"{BASE_URL}/patients", headers=headers)
patients = response.json()["data"]

# AI è¯Šæ–­ / AI diagnosis
ai_response = requests.post(
    f"{BASE_URL}/ai/comprehensive-diagnosis",
    headers=headers,
    json={
        "symptoms": "åå¤å’³å—½ä¸€å‘¨",
        "severity": "moderate",
        "language": "zh"
    }
)
diagnosis = ai_response.json()["data"]
print(f"è¯Šæ–­ç»“æœ / Diagnosis: {diagnosis['diagnosis_result']}")
```

### 6.3 JavaScript ç¤ºä¾‹ | JavaScript Example

```javascript
const BASE_URL = 'http://localhost:8000/api/v1';

// ç™»å½• / Login
async function login(email, password, platform) {
  const response = await fetch(`${BASE_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password, platform })
  });
  const data = await response.json();
  return data.data.tokens.access_token;
}

// API è°ƒç”¨ / API call
async function apiCall(endpoint, options = {}) {
  const token = localStorage.getItem('access_token');
  const response = await fetch(`${BASE_URL}${endpoint}`, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
  return response.json();
}

// ä½¿ç”¨ç¤ºä¾‹ / Usage example
async function example() {
  const token = await login('test@medicare.ai', 'Test123456!', 'patient');
  localStorage.setItem('access_token', token);
  
  // è·å–ç—…ä¾‹åˆ—è¡¨ / Get case list
  const cases = await apiCall('/medical-cases');
  console.log('ç—…ä¾‹åˆ—è¡¨ / Cases:', cases);
  
  // AI è¯Šæ–­ / AI diagnosis
  const diagnosis = await apiCall('/ai/comprehensive-diagnosis', {
    method: 'POST',
    body: JSON.stringify({
      symptoms: 'åå¤å’³å—½ä¸€å‘¨',
      severity: 'moderate',
      language: 'zh'
    })
  });
  console.log('è¯Šæ–­ç»“æœ / Diagnosis:', diagnosis);
}
```

---

## å‚è€ƒèµ„æº | Reference Resources

- [OpenAPI/Swagger Documentation](http://localhost:8000/api/docs) - äº¤äº’å¼ API æ–‡æ¡£ / Interactive API docs
- [ReDoc Documentation](http://localhost:8000/api/redoc) - æ›¿ä»£ API æ–‡æ¡£æ ¼å¼ / Alternative API docs format
- [FastAPI Documentation](https://fastapi.tiangolo.com/) - FastAPI æ¡†æ¶æ–‡æ¡£ / FastAPI framework docs

---

**æ–‡æ¡£ç‰ˆæœ¬ / Document Version**: 2.0.0  
**æœ€åæ›´æ–° / Last Updated**: 2026-02-09  
**ä½œè€… / Author**: è‹ä¸šé’¦ (Su Yeqin)
