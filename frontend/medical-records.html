<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥</text></svg>">
    <title>è¯Šç–—è®°å½• - MediCare AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
        }

        .nav a {
            padding: 10px 20px;
            text-decoration: none;
            color: #666;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav a:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .nav a.active {
            background: #667eea;
            color: white;
        }

        .filter-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            flex: 1;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .search-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .back-btn {
            display: inline-block;
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            margin-top: 20px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .action-bar {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .records-list {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .record-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .record-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .record-date {
            font-size: 14px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .record-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .record-status.active {
            background: #d4edda;
            color: #155724;
        }

        .record-status.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .record-status.archived {
            background: #e9ecef;
            color: #6c757d;
        }

        .record-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .record-detail {
            display: flex;
            margin-bottom: 10px;
            align-items: flex-start;
            gap: 10px;
        }

        .detail-label {
            font-weight: 500;
            color: #555;
            min-width: 80px;
        }

        .detail-value {
            color: #333;
            flex: 1;
            line-height: 1.6;
        }

        .record-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .result {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            line-height: 1.6;
        }

        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .result-content {
            color: #555;
        }

        .btn-view {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 15px;
        }

        .btn-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .empty-action {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid #667eea;
            border-top-color: #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .detail-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .detail-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-content {
            color: #333;
            line-height: 1.8;
            font-size: 15px;
        }

        .detail-content.markdown-body {
            font-size: 15px;
        }

        .detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-meta-label {
            color: #666;
            font-size: 14px;
        }

        .detail-meta-value {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            .nav, .filter-bar, .action-bar, .btn-view, .modal-footer,
            .detail-actions, .compare-btn, .annotation-input {
                display: none !important;
            }
            .container {
                max-width: 100%;
                padding: 0;
            }
            .record-card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
            .modal {
                position: static;
                display: block !important;
                background: white;
            }
            .modal-content {
                box-shadow: none;
                max-height: none;
                width: 100%;
            }
            .modal-header {
                background: #333;
                color: white;
            }
        }

        /* Action Buttons in Modal */
        .detail-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .action-btn.pdf {
            background: #dc3545;
            color: white;
        }

        .action-btn.share {
            background: #28a745;
            color: white;
        }

        .action-btn.print {
            background: #6c757d;
            color: white;
        }

        .action-btn.compare {
            background: #17a2b8;
            color: white;
        }

        .action-btn.note {
            background: #ffc107;
            color: #333;
        }

        /* Annotations Section */
        .annotations-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }

        .annotation-list {
            margin-bottom: 15px;
        }

        .annotation-item {
            background: #fffbf0;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .annotation-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }

        .annotation-author {
            font-weight: 600;
            color: #333;
        }

        .annotation-content {
            color: #333;
            line-height: 1.6;
        }

        .annotation-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .annotation-input textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .annotation-input textarea:focus {
            outline: none;
            border-color: #ffc107;
        }

        /* Comparison Styles */
        .compare-modal .modal-content {
            max-width: 1200px;
        }

        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .compare-column {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .compare-column h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 18px;
        }

        .compare-select {
            margin-bottom: 20px;
        }

        .compare-select label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .compare-select select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Share Modal */
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .share-link-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .share-link-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .share-link-input {
            display: flex;
            gap: 10px;
        }

        .share-link-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .qr-section {
            text-align: center;
            padding: 20px;
        }

        .qr-section label {
            display: block;
            margin-bottom: 15px;
            font-weight: 500;
            color: #555;
        }

        #qrcode {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Share Tabs */
        .share-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .share-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .share-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 500;
        }

        .share-panel {
            display: none;
        }

        .share-panel.active {
            display: block;
        }

        /* Doctor Search */
        .doctor-search-section {
            margin-bottom: 20px;
        }

        .doctor-search-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .doctor-search-input {
            display: flex;
            gap: 10px;
        }

        .doctor-search-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .doctor-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .doctor-results-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .doctor-card {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .doctor-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .doctor-card.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .doctor-card-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .doctor-card-info {
            font-size: 13px;
            color: #666;
        }

        .selected-doctor {
            background: #f0f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .selected-doctor h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .selected-doctor-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #667eea;
        }

        .consent-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .consent-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .consent-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .consent-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¯Šç–—è®°å½•</h1>
            <div class="user-info">
                <div class="avatar">æ‚£</div>
                <span id="userName"></span>
            </div>
        </div>

        <div class="nav">
            <a href="index.html">é¦–é¡µ</a>
            <a href="user-profile.html">ä¸ªäººä¸­å¿ƒ</a>
            <a href="symptom-submit.html">ç—‡çŠ¶æäº¤</a>
            <a href="medical-records.html" class="active">è¯Šç–—è®°å½•</a>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>å…³é”®è¯æœç´¢</label>
                <input type="text" id="searchKeyword" placeholder="æœç´¢è¯Šæ–­ã€ç—‡çŠ¶...">
            </div>
            <div class="filter-group">
                <label>æ—¶é—´èŒƒå›´</label>
                <select id="timeRange">
                    <option value="">å…¨éƒ¨æ—¶é—´</option>
                    <option value="7">æœ€è¿‘7å¤©</option>
                    <option value="30">æœ€è¿‘30å¤©</option>
                    <option value="90">æœ€è¿‘3ä¸ªæœˆ</option>
                    <option value="180">æœ€è¿‘6ä¸ªæœˆ</option>
                </select>
            </div>
            <button class="search-btn" onclick="loadRecords()">æœç´¢</button>
        </div>

        <div class="records-list" id="recordsList">
            <div class="loading">
                <span class="spinner"></span> åŠ è½½ä¸­...
            </div>
        </div>

        <div class="action-bar">
            <a href="index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ©º è¯Šç–—è¯¦æƒ…</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¯¹æ¯”æ¨¡æ€æ¡† -->
    <div id="compareModal" class="modal compare-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“Š ç—…å†å¯¹æ¯”</h2>
                <span class="close-btn" onclick="closeCompareModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="compare-container">
                    <div class="compare-column">
                        <div class="compare-select">
                            <label>é€‰æ‹©ç¬¬ä¸€ä»½ç—…å†</label>
                            <select id="compareSelect1" onchange="updateCompareView()">
                                <option value="">è¯·é€‰æ‹©...</option>
                            </select>
                        </div>
                        <div id="compareContent1">
                            <p style="color: #999; text-align: center; padding: 40px;">è¯·é€‰æ‹©è¦å¯¹æ¯”çš„ç—…å†</p>
                        </div>
                    </div>
                    <div class="compare-column">
                        <div class="compare-select">
                            <label>é€‰æ‹©ç¬¬äºŒä»½ç—…å†</label>
                            <select id="compareSelect2" onchange="updateCompareView()">
                                <option value="">è¯·é€‰æ‹©...</option>
                            </select>
                        </div>
                        <div id="compareContent2">
                            <p style="color: #999; text-align: center; padding: 40px;">è¯·é€‰æ‹©è¦å¯¹æ¯”çš„ç—…å†</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeCompareModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«æ¨¡æ€æ¡† -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ”— åˆ†äº«è¯Šæ–­æŠ¥å‘Š</h2>
                <span class="close-btn" onclick="closeShareModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="share-tabs">
                    <button class="share-tab active" onclick="switchShareTab('link')" id="tabLink">é“¾æ¥åˆ†äº«</button>
                    <button class="share-tab" onclick="switchShareTab('doctor')" id="tabDoctor">@åŒ»ç”Ÿ</button>
                </div>
                
                <!-- é“¾æ¥åˆ†äº« -->
                <div id="shareLinkPanel" class="share-panel active">
                    <div class="share-options">
                        <div class="share-link-section">
                            <label>åˆ†äº«é“¾æ¥</label>
                            <div class="share-link-input">
                                <input type="text" id="shareLink" readonly>
                                <button class="copy-btn" onclick="copyShareLink()">å¤åˆ¶</button>
                            </div>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" id="includeDiagnosis" checked onchange="updateShareLink()">
                                    åŒ…å«è¯Šæ–­ç»“æœ
                                </label>
                                <label>
                                    <input type="checkbox" id="includeSymptoms" checked onchange="updateShareLink()">
                                    åŒ…å«ç—‡çŠ¶æè¿°
                                </label>
                                <label>
                                    <input type="checkbox" id="includePersonal" onchange="updateShareLink()">
                                    åŒ…å«ä¸ªäººä¿¡æ¯
                                </label>
                            </div>
                        </div>
                        <div class="qr-section">
                            <label>æ‰«æäºŒç»´ç åˆ†äº«</label>
                            <div id="qrcode"></div>
                        </div>
                    </div>
                </div>
                
                <!-- @åŒ»ç”Ÿ -->
                <div id="shareDoctorPanel" class="share-panel" style="display: none;">
                    <div class="doctor-search-section">
                        <label>æœç´¢åŒ»ç”Ÿ</label>
                        <div class="doctor-search-input">
                            <input type="text" id="doctorSearchInput" placeholder="è¾“å…¥åŒ»ç”Ÿå§“åã€åŒ»é™¢æˆ–ä¸“ä¸šé¢†åŸŸ" oninput="searchDoctors()">
                            <button class="search-btn" onclick="searchDoctors()">ğŸ”</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">æ˜¾ç¤ºçš„éƒ½æ˜¯å·²è®¤è¯åŒ»ç”Ÿï¼Œåªå±•ç¤ºæ˜µç§°ï¼Œä¸æš´éœ²çœŸå®å§“å</small>
                    </div>
                    
                    <div id="doctorSearchResults" class="doctor-results">
                        <div class="doctor-results-empty">è¾“å…¥å…³é”®è¯æœç´¢åŒ»ç”Ÿ...</div>
                    </div>
                    
                    <div id="selectedDoctorInfo" class="selected-doctor" style="display: none;">
                        <h4>å·²é€‰æ‹©åŒ»ç”Ÿ</h4>
                        <div class="selected-doctor-card">
                            <div class="doctor-name" id="selectedDoctorName"></div>
                            <div class="doctor-info" id="selectedDoctorInfo"></div>
                        </div>
                    </div>
                    
                    <div class="consent-section">
                        <label>åˆ†äº«æˆæƒ</label>
                        <div class="consent-text">
                            <p>æ‚¨å³å°†å°†æ­¤ç—…ä¾‹åˆ†äº«ç»™æŒ‡å®šçš„åŒ»ç”Ÿã€‚åˆ†äº«å†…å®¹å°†è‡ªåŠ¨è„±æ•å¤„ç†ï¼Œéšè—æ‚¨çš„å§“åã€èº«ä»½è¯å·ã€æ‰‹æœºå·ç­‰æ•æ„Ÿä¿¡æ¯ã€‚</p>
                            <p>åŒ»ç”Ÿå°†å¯ä»¥æŸ¥çœ‹ï¼šç—‡çŠ¶æè¿°ã€AIè¯Šæ–­ç»“æœã€æ£€æŸ¥èµ„æ–™ï¼ˆå·²è„±æ•ï¼‰</p>
                        </div>
                        <label class="consent-checkbox">
                            <input type="checkbox" id="shareConsent" checked>
                            æˆ‘å·²é˜…è¯»å¹¶åŒæ„åˆ†äº«æ­¤ç—…ä¾‹ç»™é€‰å®šçš„åŒ»ç”Ÿ
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeShareModal()">å…³é—­</button>
                <button class="btn-primary" id="shareActionBtn" onclick="shareToDoctor()" style="display: none;">åˆ†äº«ç»™åŒ»ç”Ÿ</button>
            </div>
        </div>
    </div>

    <!-- Markdown Parser Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- QR Code Library for Sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const API_BASE = '';

        // å¤„ç† 401 é”™è¯¯
        function handleUnauthorized() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_name');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_id');
            window.location.href = '/login.html';
        }

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                handleUnauthorized();
            } else {
                const userName = localStorage.getItem('user_name') || 'æ‚£è€…';
                document.getElementById('userName').textContent = userName;
            }
        }

        // åŠ è½½è¯Šç–—è®°å½•
        async function loadRecords() {
            const token = localStorage.getItem('access_token');
            const recordsList = document.getElementById('recordsList');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            recordsList.innerHTML = '<div class="empty-state"><div class="empty-icon">â³</div><div class="empty-text">åŠ è½½ä¸­...</div></div>';

            // åŠ è½½ç—…å†è®°å½•
            try {
                const response = await fetch(`${API_BASE}/api/v1/medical-cases/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (response.ok) {
                    const cases = await response.json();
                    displayMedicalCases(cases);
                } else {
                    const error = await response.json();
                    console.error('åŠ è½½å¤±è´¥:', error);
                    recordsList.innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ</div><div class="empty-text">åŠ è½½å¤±è´¥ï¼š' + (error.detail || 'æœªçŸ¥é”™è¯¯') + '</div></div>';
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                recordsList.innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ</div><div class="empty-text">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div></div>';
            }
        }

        function displayMedicalCases(cases) {
            const recordsList = document.getElementById('recordsList');

            // ä¿å­˜å½“å‰ç—…å†æ•°æ®ä¾›è¯¦æƒ…æŸ¥çœ‹ä½¿ç”¨
            currentMedicalCases = cases;

            if (cases.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ— è¯Šç–—è®°å½•</div>
                        <a href="symptom-submit.html" class="empty-action">æäº¤ç—‡çŠ¶è¿›è¡ŒAIè¯Šæ–­</a>
                    </div>
                `;
                return;
            }

            let html = '';
            cases.forEach(caseItem => {
                const date = new Date(caseItem.created_at).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // æˆªæ–­ç—‡çŠ¶å’Œè¯Šæ–­æ–‡æœ¬
                const symptoms = caseItem.symptoms ? caseItem.symptoms.substring(0, 100) + '...' : 'æ— ç—‡çŠ¶æè¿°';
                const diagnosis = caseItem.diagnosis ? caseItem.diagnosis.substring(0, 150) + '...' : 'è¯Šæ–­ä¸­...';

                html += `
                    <div class="record-card">
                        <div class="record-header">
                            <div class="record-date">
                                ğŸ“… ${date}
                            </div>
                            <span class="record-status ${caseItem.status}">${caseItem.status === 'active' ? 'è¿›è¡Œä¸­' : caseItem.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å½’æ¡£'}</span>
                        </div>
                        <div class="record-title">${caseItem.title || 'AIè¯Šç–—è®°å½•'}</div>
                        <div class="record-detail">
                            <div class="detail-label">ä¸¥é‡ç¨‹åº¦ï¼š</div>
                            <div class="detail-value"><span class="severity-badge ${caseItem.severity}">${caseItem.severity || 'æœªçŸ¥'}</span></div>
                        </div>
                        <div class="record-detail">
                            <div class="detail-label">ç—‡çŠ¶ï¼š</div>
                            <div class="detail-value">${symptoms}</div>
                        </div>
                        <div class="record-detail">
                            <div class="detail-label">AIè¯Šæ–­ï¼š</div>
                            <div class="detail-value" style="color: #667eea; font-style: italic;">${diagnosis}</div>
                        </div>
                        <button class="btn-view" onclick="viewCaseDetail('${caseItem.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        // å­˜å‚¨å½“å‰åŠ è½½çš„ç—…å†æ•°æ®
        let currentMedicalCases = [];

        function viewCaseDetail(caseId) {
            // ä»å·²åŠ è½½çš„æ•°æ®ä¸­æŸ¥æ‰¾ç—…å†
            const caseItem = currentMedicalCases.find(c => c.id === caseId);

            if (!caseItem) {
                alert('æ— æ³•æ‰¾åˆ°è¯¥ç—…å†è¯¦æƒ…');
                return;
            }

            // æ„å»ºè¯¦æƒ…HTML
            const date = new Date(caseItem.created_at).toLocaleString('zh-CN');
            const statusText = caseItem.status === 'active' ? 'è¿›è¡Œä¸­' :
                              caseItem.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å½’æ¡£';
            const statusClass = caseItem.status;

            // ä½¿ç”¨marked.jsæ¸²æŸ“Markdownè¯Šæ–­å†…å®¹
            const diagnosisHtml = caseItem.diagnosis ?
                marked.parse(caseItem.diagnosis) :
                '<p style="color: #999;">æš‚æ— è¯Šæ–­ç»“æœ</p>';

            const modalHtml = `
                <div class="detail-meta">
                    <div class="detail-meta-item">
                        <span class="detail-meta-label">ğŸ“… åˆ›å»ºæ—¶é—´ï¼š</span>
                        <span class="detail-meta-value">${date}</span>
                    </div>
                    <div class="detail-meta-item">
                        <span class="detail-meta-label">ğŸ“‹ çŠ¶æ€ï¼š</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="detail-meta-item">
                        <span class="detail-meta-label">âš ï¸ ä¸¥é‡ç¨‹åº¦ï¼š</span>
                        <span class="detail-meta-value">${caseItem.severity || 'æœªçŸ¥'}</span>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“ ç—…å†æ ‡é¢˜</div>
                    <div class="detail-content">${caseItem.title || 'AIè¯Šç–—è®°å½•'}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">ğŸ˜· ç—‡çŠ¶æè¿°</div>
                    <div class="detail-content">${caseItem.symptoms || 'æœªè®°å½•ç—‡çŠ¶'}</div>
                </div>

                ${caseItem.description ? `
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“„ è¯¦ç»†æè¿°</div>
                    <div class="detail-content">${caseItem.description}</div>
                </div>
                ` : ''}

                <div class="detail-section">
                    <div class="detail-section-title">ğŸ¤– AIè¯Šæ–­ç»“æœ</div>
                    <div class="detail-content markdown-body" id="diagnosisContent">${diagnosisHtml}</div>
                </div>

                <!-- åŒ»ç”Ÿæ‰¹æ³¨åŒºåŸŸ -->
                <div class="annotations-section" id="annotationsSection">
                    <div class="detail-section-title">ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿåé¦ˆ</div>
                    <div class="annotation-list" id="annotationList">
                        <p style="color: #999; font-style: italic;">æ­£åœ¨åŠ è½½åŒ»ç”Ÿåé¦ˆ...</p>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="detail-actions">
                    <button class="action-btn pdf" onclick="exportToPDF('${caseItem.id}')">
                        ğŸ“„ å¯¼å‡ºPDF
                    </button>
                    <button class="action-btn share" onclick="openShareModal('${caseItem.id}')">
                        ğŸ”— åˆ†äº«
                    </button>
                    <button class="action-btn print" onclick="printDiagnosis()">
                        ğŸ–¨ï¸ æ‰“å°
                    </button>
                    <button class="action-btn compare" onclick="openCompareModal('${caseItem.id}')">
                        ğŸ“Š å¯¹æ¯”
                    </button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = modalHtml;
            document.getElementById('detailModal').classList.add('show');

            // å­˜å‚¨å½“å‰æŸ¥çœ‹çš„ç—…å†ID
            window.currentViewingCaseId = caseId;
            
            // åŠ è½½åŒ»ç”Ÿè¯„è®º
            loadDoctorComments(caseId);
        }
        
        // åŠ è½½åŒ»ç”Ÿè¯„è®º
        async function loadDoctorComments(caseId) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                document.getElementById('annotationList').innerHTML = 
                    '<p style="color: #999; font-style: italic;">è¯·å…ˆç™»å½•æŸ¥çœ‹åŒ»ç”Ÿåé¦ˆ</p>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/medical-cases/${caseId}/doctor-comments`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('è·å–åŒ»ç”Ÿåé¦ˆå¤±è´¥');
                }
                
                const comments = await response.json();
                renderDoctorComments(comments);
            } catch (error) {
                console.error('åŠ è½½åŒ»ç”Ÿè¯„è®ºå¤±è´¥:', error);
                document.getElementById('annotationList').innerHTML = 
                    '<p style="color: #999; font-style: italic;">åŠ è½½åŒ»ç”Ÿåé¦ˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
        }
        
        // æ¸²æŸ“åŒ»ç”Ÿè¯„è®º
        function renderDoctorComments(comments) {
            const container = document.getElementById('annotationList');
            
            if (!comments || comments.length === 0) {
                container.innerHTML = 
                    '<p style="color: #999; font-style: italic;">æš‚æ— åŒ»ç”Ÿåé¦ˆ</p>';
                return;
            }
            
            const commentTypeLabels = {
                'suggestion': 'å»ºè®®',
                'diagnosis_opinion': 'è¯Šæ–­æ„è§',
                'treatment_advice': 'æ²»ç–—å»ºè®®',
                'general': 'ä¸€èˆ¬è¯„è®º'
            };
            
            container.innerHTML = comments.map(comment => {
                const typeLabel = commentTypeLabels[comment.comment_type] || 'åé¦ˆ';
                const date = new Date(comment.created_at).toLocaleString('zh-CN');
                
                // Render patient replies
                let repliesHtml = '';
                if (comment.patient_replies && comment.patient_replies.length > 0) {
                    repliesHtml = comment.patient_replies.map(reply => {
                        const replyDate = new Date(reply.created_at).toLocaleString('zh-CN');
                        return `
                            <div class="patient-reply" style="
                                background: #f0f8ff;
                                border-left: 3px solid #28a745;
                                padding: 10px 12px;
                                margin-top: 10px;
                                margin-left: 20px;
                                border-radius: 6px;
                                font-size: 14px;
                            ">
                                <div style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-bottom: 6px;
                                ">
                                    <span style="font-weight: 600; color: #28a745;">ğŸ™‹ æˆ‘çš„å›å¤</span>
                                    <span style="color: #999; font-size: 12px;">${replyDate}</span>
                                </div>
                                <div style="color: #333; line-height: 1.5;">${escapeHtml(reply.content)}</div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Reply form (hidden by default)
                const replyFormId = `reply-form-${comment.id}`;
                const replyFormHtml = `
                    <div id="${replyFormId}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e0e0e0;">
                        <textarea id="reply-text-${comment.id}" placeholder="è¾“å…¥æ‚¨çš„å›å¤..." style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            resize: vertical;
                            min-height: 60px;
                            font-family: inherit;
                            font-size: 14px;
                            margin-bottom: 8px;
                        "></textarea>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="toggleReplyForm('${comment.id}')" style="
                                padding: 6px 12px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 13px;
                            ">å–æ¶ˆ</button>
                            <button onclick="submitReply('${comment.id}')" style="
                                padding: 6px 12px;
                                background: #28a745;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 13px;
                            ">å‘é€å›å¤</button>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="annotation-item" style="
                        background: #f8f9ff;
                        border-left: 4px solid #667eea;
                        padding: 15px;
                        margin-bottom: 15px;
                        border-radius: 8px;
                    ">
                        <div class="annotation-header" style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 10px;
                            padding-bottom: 8px;
                            border-bottom: 1px solid #e0e0e0;
                        ">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="annotation-author" style="
                                    font-weight: 600;
                                    color: #667eea;
                                ">ğŸ‘¨â€âš•ï¸ ${comment.doctor_name}</span>
                                <span style="
                                    background: #667eea;
                                    color: white;
                                    padding: 2px 8px;
                                    border-radius: 12px;
                                    font-size: 12px;
                                ">${typeLabel}</span>
                            </div>
                            <span style="color: #999; font-size: 13px;">${date}</span>
                        </div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 10px;">
                            ğŸ¥ ${comment.doctor_hospital} Â· ${comment.doctor_specialty}
                        </div>
                        <div class="annotation-content" style="
                            line-height: 1.6;
                            color: #333;
                            white-space: pre-wrap;
                            margin-bottom: 10px;
                        ">${escapeHtml(comment.content)}</div>
                        
                        ${repliesHtml}
                        
                        <div style="margin-top: 10px;">
                            <button onclick="toggleReplyForm('${comment.id}')" style="
                                padding: 5px 12px;
                                background: transparent;
                                color: #667eea;
                                border: 1px solid #667eea;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 13px;
                                display: flex;
                                align-items: center;
                                gap: 5px;
                            ">
                                ğŸ’¬ å›å¤åŒ»ç”Ÿ
                            </button>
                        </div>
                        
                        ${replyFormHtml}
                    </div>
                `;
            }).join('');
        }
        
        // Toggle reply form visibility
        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Submit patient reply
        async function submitReply(commentId) {
            const caseId = window.currentViewingCaseId;
            const textarea = document.getElementById(`reply-text-${commentId}`);
            const content = textarea.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥å›å¤å†…å®¹');
                return;
            }
            
            const token = localStorage.getItem('access_token');
            if (!token) {
                handleUnauthorized();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/medical-cases/${caseId}/doctor-comments/${commentId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'å‘é€å›å¤å¤±è´¥');
                }
                
                // Clear textarea and hide form
                textarea.value = '';
                toggleReplyForm(commentId);
                
                // Reload comments to show the new reply
                await loadDoctorComments(caseId);
                
                alert('å›å¤å·²å‘é€');
            } catch (error) {
                console.error('å‘é€å›å¤å¤±è´¥:', error);
                alert('å‘é€å›å¤å¤±è´¥: ' + error.message);
            }
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¯¼å‡ºPDFåŠŸèƒ½
        function exportToPDF(caseId) {
            const caseItem = currentMedicalCases.find(c => c.id === caseId);
            if (!caseItem) return;

            const element = document.getElementById('modalBody');
            const opt = {
                margin: 10,
                filename: `è¯Šæ–­æŠ¥å‘Š_${caseItem.title || 'ç—…å†'}_${new Date().toLocaleDateString('zh-CN')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // ä¸´æ—¶éšè—æ“ä½œæŒ‰é’®
            const actions = element.querySelector('.detail-actions');
            const annotationInput = element.querySelector('.annotation-input');
            if (actions) actions.style.display = 'none';
            if (annotationInput) annotationInput.style.display = 'none';

            html2pdf().set(opt).from(element).save().then(() => {
                // æ¢å¤æ“ä½œæŒ‰é’®
                if (actions) actions.style.display = 'flex';
                if (annotationInput) annotationInput.style.display = 'flex';
            });
        }

        // æ‰“å°åŠŸèƒ½
        function printDiagnosis() {
            window.print();
        }

        // æ‰“å¼€åˆ†äº«æ¨¡æ€æ¡†
        function openShareModal(caseId) {
            const caseItem = currentMedicalCases.find(c => c.id === caseId);
            if (!caseItem) return;

            window.currentSharingCaseId = caseId;

            // ç”Ÿæˆåˆ†äº«é“¾æ¥
            updateShareLink();

            // ç”ŸæˆäºŒç»´ç 
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            const shareUrl = document.getElementById('shareLink').value;
            new QRCode(qrContainer, {
                text: shareUrl,
                width: 150,
                height: 150,
                colorDark: '#667eea',
                colorLight: '#ffffff'
            });

            document.getElementById('shareModal').classList.add('show');
        }

        // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('show');
        }

        // æ›´æ–°åˆ†äº«é“¾æ¥
        function updateShareLink() {
            const caseId = window.currentSharingCaseId;
            const caseItem = currentMedicalCases.find(c => c.id === caseId);
            if (!caseItem) return;

            const baseUrl = window.location.origin;
            const params = new URLSearchParams();
            params.set('case', caseId);
            params.set('d', document.getElementById('includeDiagnosis').checked ? '1' : '0');
            params.set('s', document.getElementById('includeSymptoms').checked ? '1' : '0');
            params.set('p', document.getElementById('includePersonal').checked ? '1' : '0');

            const shareUrl = `${baseUrl}/share.html?${params.toString()}`;
            document.getElementById('shareLink').value = shareUrl;

            // æ›´æ–°äºŒç»´ç 
            const qrContainer = document.getElementById('qrcode');
            if (qrContainer) {
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: shareUrl,
                    width: 150,
                    height: 150,
                    colorDark: '#667eea',
                    colorLight: '#ffffff'
                });
            }
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        // åˆ‡æ¢åˆ†äº«æ ‡ç­¾
        function switchShareTab(tab) {
            document.querySelectorAll('.share-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.share-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.share-panel').forEach(p => p.style.display = 'none');

            if (tab === 'link') {
                document.getElementById('tabLink').classList.add('active');
                document.getElementById('shareLinkPanel').classList.add('active');
                document.getElementById('shareLinkPanel').style.display = 'block';
                document.getElementById('shareActionBtn').style.display = 'none';
            } else {
                document.getElementById('tabDoctor').classList.add('active');
                document.getElementById('shareDoctorPanel').classList.add('active');
                document.getElementById('shareDoctorPanel').style.display = 'block';
                document.getElementById('shareActionBtn').style.display = 'inline-block';
                document.getElementById('shareActionBtn').textContent = '@æåŠåŒ»ç”Ÿ';
            }
        }

        // æœç´¢åŒ»ç”Ÿ
        async function searchDoctors() {
            const query = document.getElementById('doctorSearchInput').value.trim();
            const resultsContainer = document.getElementById('doctorSearchResults');

            if (!query) {
                resultsContainer.innerHTML = '<div class="doctor-results-empty">è¾“å…¥å…³é”®è¯æœç´¢åŒ»ç”Ÿ...</div>';
                return;
            }

            resultsContainer.innerHTML = '<div class="doctor-results-empty">æœç´¢ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/v1/sharing/doctors?q=${encodeURIComponent(query)}&limit=20`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('æœç´¢å¤±è´¥');
                }

                const doctors = await response.json();

                if (doctors.length === 0) {
                    resultsContainer.innerHTML = '<div class="doctor-results-empty">æœªæ‰¾åˆ°åŒ¹é…çš„åŒ»ç”Ÿ</div>';
                    return;
                }

                resultsContainer.innerHTML = doctors.map(doctor => `
                    <div class="doctor-card" onclick="selectDoctor('${doctor.id}', '${doctor.display_name}', '${doctor.hospital}', '${doctor.department}', '${doctor.specialty}')">
                        <div class="doctor-card-name">${doctor.display_name}</div>
                        <div class="doctor-card-info">
                            ${doctor.hospital || 'æœªçŸ¥åŒ»é™¢'} Â· ${doctor.department || 'æœªçŸ¥ç§‘å®¤'}<br>
                            <small style="color: #999;">ä¸“ä¸šé¢†åŸŸï¼š${doctor.specialty || 'æœªå¡«å†™'}</small>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                resultsContainer.innerHTML = '<div class="doctor-results-empty">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // é€‰æ‹©åŒ»ç”Ÿ
        let selectedDoctorId = null;
        function selectDoctor(id, name, hospital, department, specialty) {
            selectedDoctorId = id;

            document.querySelectorAll('.doctor-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            document.getElementById('selectedDoctorName').textContent = name;
            document.getElementById('selectedDoctorInfo').innerHTML = `
                <strong>${hospital || 'æœªçŸ¥åŒ»é™¢'}</strong> Â· ${department || 'æœªçŸ¥ç§‘å®¤'}<br>
                <small>ä¸“ä¸šé¢†åŸŸï¼š${specialty || 'æœªå¡«å†™'}</small>
            `;
            document.getElementById('selectedDoctorInfo').style.display = 'block';
        }

        // åˆ†äº«ç»™åŒ»ç”Ÿ
        async function shareToDoctor() {
            if (!selectedDoctorId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä½åŒ»ç”Ÿ');
                return;
            }

            if (!document.getElementById('shareConsent').checked) {
                alert('è¯·å‹¾é€‰åŒæ„åˆ†äº«çš„é€‰é¡¹');
                return;
            }

            const caseId = window.currentSharingCaseId;
            if (!caseId) {
                alert('æ— æ³•è·å–ç—…ä¾‹ä¿¡æ¯');
                return;
            }

            const btn = document.getElementById('shareActionBtn');
            btn.disabled = true;
            btn.textContent = 'åˆ†äº«ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/v1/sharing/cases/${caseId}/share`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_type: 'specific_doctor',
                        doctor_id: selectedDoctorId,
                        consent_text: 'æˆ‘å·²é˜…è¯»å¹¶åŒæ„å°†ç—…ä¾‹åˆ†äº«ç»™é€‰å®šçš„åŒ»ç”Ÿï¼Œåˆ†äº«å†…å®¹å°†è‡ªåŠ¨è„±æ•å¤„ç†ã€‚',
                        include_history: false,
                        valid_days: 365
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'åˆ†äº«å¤±è´¥');
                }

                const result = await response.json();
                alert('ç—…ä¾‹å·²æˆåŠŸåˆ†äº«ç»™åŒ»ç”Ÿï¼åŒ»ç”Ÿå°†æ”¶åˆ°é€šçŸ¥ã€‚');
                closeShareModal();

                // é‡ç½®é€‰æ‹©
                selectedDoctorId = null;
                document.getElementById('selectedDoctorInfo').style.display = 'none';
                document.getElementById('doctorSearchInput').value = '';
                document.getElementById('doctorSearchResults').innerHTML = '<div class="doctor-results-empty">è¾“å…¥å…³é”®è¯æœç´¢åŒ»ç”Ÿ...</div>';
            } catch (error) {
                alert('åˆ†äº«å¤±è´¥ï¼š' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '@æåŠåŒ»ç”Ÿ';
            }
        }

        // æ‰“å¼€å¯¹æ¯”æ¨¡æ€æ¡†
        function openCompareModal(caseId) {
            // å¡«å……é€‰æ‹©å™¨
            const select1 = document.getElementById('compareSelect1');
            const select2 = document.getElementById('compareSelect2');

            select1.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
            select2.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';

            currentMedicalCases.forEach(c => {
                const date = new Date(c.created_at).toLocaleDateString('zh-CN');
                const option = `<option value="${c.id}">${date} - ${c.title || 'è¯Šç–—è®°å½•'}</option>`;
                select1.innerHTML += option;
                select2.innerHTML += option;
            });

            // é¢„é€‰å½“å‰ç—…å†
            if (caseId) {
                select1.value = caseId;
                updateCompareView();
            }

            document.getElementById('compareModal').classList.add('show');
        }

        // å…³é—­å¯¹æ¯”æ¨¡æ€æ¡†
        function closeCompareModal() {
            document.getElementById('compareModal').classList.remove('show');
        }

        // æ›´æ–°å¯¹æ¯”è§†å›¾
        function updateCompareView() {
            const id1 = document.getElementById('compareSelect1').value;
            const id2 = document.getElementById('compareSelect2').value;

            if (id1) {
                const case1 = currentMedicalCases.find(c => c.id === id1);
                document.getElementById('compareContent1').innerHTML = renderCompareContent(case1);
            }

            if (id2) {
                const case2 = currentMedicalCases.find(c => c.id === id2);
                document.getElementById('compareContent2').innerHTML = renderCompareContent(case2);
            }
        }

        // æ¸²æŸ“å¯¹æ¯”å†…å®¹
        function renderCompareContent(caseItem) {
            if (!caseItem) return '<p style="color: #999;">è¯·é€‰æ‹©ç—…å†</p>';

            const date = new Date(caseItem.created_at).toLocaleString('zh-CN');
            const diagnosisHtml = caseItem.diagnosis ? marked.parse(caseItem.diagnosis) : 'æš‚æ— è¯Šæ–­';

            return `
                <div class="detail-meta" style="margin-bottom: 15px;">
                    <div class="detail-meta-item">
                        <span class="detail-meta-label">ğŸ“… æ—¶é—´ï¼š</span>
                        <span class="detail-meta-value">${date}</span>
                    </div>
                    <div class="detail-meta-item">
                        <span class="detail-meta-label">âš ï¸ ä¸¥é‡ç¨‹åº¦ï¼š</span>
                        <span class="detail-meta-value">${caseItem.severity || 'æœªçŸ¥'}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ˜· ç—‡çŠ¶</div>
                    <div class="detail-content">${caseItem.symptoms || 'æœªè®°å½•'}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ¤– AIè¯Šæ–­</div>
                    <div class="detail-content markdown-body">${diagnosisHtml}</div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const shareModal = document.getElementById('shareModal');
            const compareModal = document.getElementById('compareModal');

            if (event.target === detailModal) {
                closeModal();
            } else if (event.target === shareModal) {
                closeShareModal();
            } else if (event.target === compareModal) {
                closeCompareModal();
            }
        }

        // æ˜¾ç¤ºè®°å½•åˆ—è¡¨ï¼ˆå¤‡ç”¨å‡½æ•°ï¼‰
        function displayRecords(records) {
            const recordsList = document.getElementById('recordsList');

            if (records.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ— è¯Šç–—è®°å½•</div>
                        <a href="symptom-submit.html" class="empty-action">å¼€å§‹ç¬¬ä¸€æ¬¡ç—‡çŠ¶æäº¤</a>
                    </div>
                `;
                return;
            }

            let html = '';
            records.forEach(record => {
                const date = new Date(record.created_at).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const time = new Date(record.created_at).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusClass = record.status || 'active';
                const statusText = {
                    'active': 'è¿›è¡Œä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'archived': 'å·²å½’æ¡£'
                }[statusClass] || 'è¿›è¡Œä¸­';

                html += `
                    <div class="record-card">
                        <div class="record-header">
                            <div class="record-date">
                                ğŸ“… ${date} ${time}
                            </div>
                            <span class="record-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="record-title">${record.title || 'è¯Šç–—è®°å½•'}</div>
                        <div class="record-detail">
                            <div class="detail-label">ç—‡çŠ¶ï¼š</div>
                            <div class="detail-value">${record.symptoms || 'æœªè®°å½•'}</div>
                        </div>
                        <div class="record-detail">
                            <div class="detail-label">è¯Šæ–­ï¼š</div>
                            <div class="detail-value">${record.diagnosis || 'å¾…ç¡®è®¤'}</div>
                        </div>
                        ${record.ai_recommendations ? `
                        <div class="record-section">
                            <div class="section-title">AIå»ºè®®</div>
                            <div class="result">
                                <div class="result-title">AIåˆ†æç»“æœ</div>
                                <div class="result-content">${record.ai_recommendations}</div>
                            </div>
                        </div>
                        ` : ''}
                        <button class="btn-view" onclick="viewRecord('${record.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        // æŸ¥çœ‹è®°å½•è¯¦æƒ…
        function viewRecord(caseId) {
            // å¯ä»¥æ‰“å¼€æ¨¡æ€æ¡†æˆ–è·³è½¬åˆ°è¯¦æƒ…é¡µé¢
            alert('æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½å¾…å®ç°ï¼ŒCase ID: ' + caseId);
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('load', () => {
            checkAuth();
            loadRecords();
        });
    </script>
</body>
</html>
